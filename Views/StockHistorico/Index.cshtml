@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Stock Histórico";
}

<style>
    .container-custom {
        width: 100%;
        padding-right: 15px;
        padding-left: 15px;
        margin-right: auto;
        margin-left: auto;
        max-width: 1400px;
    }

    .card {
        border: none;
        border-radius: 8px;
    }

    .card-filtros .card-title {
        color: #495057;
        font-size: 1.1rem;
    }

    .card-filtros .card-body {
        padding: 0.5rem 1rem;
    }

    .card-filtros label {
        font-size: 0.85rem;
        margin-bottom: 0.25rem;
    }

    .card-filtros .form-control,
    .card-filtros .form-select {
        font-size: 0.85rem;
    }

    .table-responsive {
        position: relative;
    }

    .table-header {
        position: sticky;
        top: 0;
        z-index: 1020;
        background-color: white;
    }

    .table-sm td,
    .table-sm th {
        font-size: 0.9em;
        text-align: center;
        vertical-align: middle;
    }

</style>

<div class="container-custom mt-3">

<!-- Card de Filtros -->
<div class="card shadow mb-2 card-filtros">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="card-title mb-0">
        <i class="fas fa-calendar-alt me-2"></i>Stock Histórico
      </h5>
    </div>
    <form id="formFiltros">
        <div class="row g-2 align-items-end">
            <!-- Fecha -->
            <div class="col-md-2">
                <label for="fecha" class="form-label">Fecha de Consulta</label>
                <input type="date" class="form-control form-control-sm" id="fecha" required>
            </div>

            <!-- Familia y Subfamilia -->
            <div class="col-md-2">
                <label for="familiaId" class="form-label">Familia</label>
                <select class="form-select form-select-sm" id="familiaId">
                    <option value="">Todas</option>
                </select>
            </div>
            <div class="col-md-2">
                <label for="subFamiliaId" class="form-label">Subfamilia</label>
                <select class="form-select form-select-sm" id="subFamiliaId">
                    <option value="">Todas</option>
                </select>
            </div>

            <!-- Código y Descripción -->
            <div class="col-md-1">
                <label for="codigo" class="form-label">Código</label>
                <input type="text" class="form-control form-control-sm" id="codigo">
            </div>
            <div class="col-md-4">
                <label for="descripcion" class="form-label">Descripción</label>
                <input type="text" class="form-control form-control-sm" id="descripcion">
            </div>

            <!-- Botones -->
            <div class="col-md-1 d-flex align-items-end gap-1">
                <button type="submit" class="btn btn-primary btn-sm">
                    <i class="fas fa-search"></i>
                </button>
                <button type="button" class="btn btn-secondary btn-sm" id="btnLimpiar" title="Limpiar filtros">
                    <i class="fas fa-eraser"></i>
                </button>
            </div>
        </div>
    </form>
  </div>
</div>

<!-- Card de Resultados -->
<div class="card shadow mb-0" id="cardResultados" style="display: none;">
  <div class="card-header bg-light d-flex align-items-center justify-content-between">
    <strong>Resultados</strong>
    <div>
        <span id="fechaConsulta" class="badge bg-info me-2" style="color: black;"></span>
        <span id="totalItems" class="badge bg-secondary"></span>
    </div>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive" style="height: 600px; overflow-y: auto;">
        <table class="table table-striped table-bordered table-sm mb-0">
            <thead class="table-header">
                <tr>
                    <th style="width: 100px;">Código</th>
                    <th style="width: 50%;">Descripción</th>
                    <th style="width: 80px;">Unidad</th>
                    <th style="width: 120px;">Stock</th>
                    <th style="width: 150px;">Fecha Movimiento</th>
                </tr>
            </thead>
            <tbody id="tablaResultados">
                <!-- Se llenará dinámicamente -->
            </tbody>
        </table>
    </div>
    <div id="mensajeVacio" class="alert alert-info text-center m-3" style="display: none;">
        <i class="fas fa-info-circle me-2"></i>No se encontraron items con los filtros especificados
    </div>
  </div>
</div>

</div>

@section Scripts {
    <script>
        let familias = [];
        let subFamilias = [];

        $(document).ready(function () {
            // Establecer fecha de hoy por defecto
            const hoy = new Date().toISOString().split('T')[0];
            $('#fecha').val(hoy);

            // Cargar familias y subfamilias
            cargarFamilias();
            cargarSubFamilias();

            // Evento change de familia
            $('#familiaId').change(function () {
                const familiaId = $(this).val();
                if (familiaId) {
                    cargarSubFamilias(familiaId);
                } else {
                    cargarSubFamilias();
                }
            });

            // Evento submit del formulario
            $('#formFiltros').submit(function (e) {
                e.preventDefault();
                consultarStock();
            });

            // Evento limpiar
            $('#btnLimpiar').click(function () {
                $('#formFiltros')[0].reset();
                $('#fecha').val(hoy);
                $('#familiaId').val('');
                $('#subFamiliaId').val('');
                $('#cardResultados').hide();
            });
        });

        function cargarFamilias() {
            $.ajax({
                url: '/api/StockHistorico/ObtenerFamilias',
                method: 'GET',
                success: function (data) {
                    familias = data;
                    $('#familiaId').empty().append('<option value="">Todas las familias</option>');
                    data.forEach(function (familia) {
                        $('#familiaId').append(`<option value="${familia.id}">${familia.descripcion}</option>`);
                    });
                },
                error: function (xhr) {
                    console.error('Error al cargar familias:', xhr);
                    Swal.fire('Error', 'No se pudieron cargar las familias', 'error');
                }
            });
        }

        function cargarSubFamilias(familiaId = null) {
            const url = familiaId 
                ? `/api/StockHistorico/ObtenerSubFamilias?familiaId=${familiaId}`
                : '/api/StockHistorico/ObtenerSubFamilias';

            $.ajax({
                url: url,
                method: 'GET',
                success: function (data) {
                    subFamilias = data;
                    $('#subFamiliaId').empty().append('<option value="">Todas las subfamilias</option>');
                    data.forEach(function (subFamilia) {
                        $('#subFamiliaId').append(`<option value="${subFamilia.id}">${subFamilia.descripcion}</option>`);
                    });
                },
                error: function (xhr) {
                    console.error('Error al cargar subfamilias:', xhr);
                    Swal.fire('Error', 'No se pudieron cargar las subfamilias', 'error');
                }
            });
        }

        function consultarStock() {
            const fecha = $('#fecha').val();
            const familiaId = $('#familiaId').val();
            const subFamiliaId = $('#subFamiliaId').val();
            const codigo = $('#codigo').val();
            const descripcion = $('#descripcion').val();

            if (!fecha) {
                Swal.fire('Advertencia', 'Debe seleccionar una fecha', 'warning');
                return;
            }

            // Mostrar loading
            Swal.fire({
                title: 'Consultando...',
                text: 'Por favor espere',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            $.ajax({
                url: '/api/StockHistorico/ConsultarStock',
                method: 'GET',
                data: {
                    fecha: fecha,
                    familiaId: familiaId || null,
                    subFamiliaId: subFamiliaId || null,
                    codigo: codigo || null,
                    descripcion: descripcion || null
                },
                success: function (response) {
                    Swal.close();
                    mostrarResultados(response.items, fecha);
                },
                error: function (xhr) {
                    Swal.close();
                    console.error('Error al consultar stock:', xhr);
                    const mensaje = xhr.responseJSON?.mensaje || 'Error al consultar el stock histórico';
                    Swal.fire('Error', mensaje, 'error');
                }
            });
        }

        function mostrarResultados(items, fecha) {
            $('#cardResultados').show();
            $('#tablaResultados').empty();

            // Actualizar badges
            const fechaFormat = new Date(fecha + 'T00:00:00').toLocaleDateString('es-AR');
            $('#fechaConsulta').text(`Fecha: ${fechaFormat}`);
            $('#totalItems').text(`${items.length} item(s)`);

            if (items.length === 0) {
                $('#mensajeVacio').show();
                return;
            }

            $('#mensajeVacio').hide();

            items.forEach(function (item) {
                const row = `
                    <tr>
                        <td class="text-center">${item.codigo}</td>
                        <td style="text-align: left;">${item.descripcion}</td>
                        <td class="text-center">${item.unidad}</td>
                        <td class="text-center"><strong>${item.stock.toFixed(2)}</strong></td>
                        <td class="text-center">${item.fechaMovimiento}</td>
                    </tr>
                `;
                $('#tablaResultados').append(row);
            });
        }
    </script>
}
