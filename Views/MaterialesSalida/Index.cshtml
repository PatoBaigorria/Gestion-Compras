@model IEnumerable<Gestion_Compras.Models.Salida>
@using Gestion_Compras.Models

@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Lista de Salidas";
}

<style>
    .container-custom {
        width: 100%;
        padding-right: 15px;
        padding-left: 15px;
        margin-right: auto;
        margin-left: auto;
        max-width: 1400px;
    }

    .table-responsive {
        position: relative;
    }

    .table-header {
        position: sticky;
        top: 0;
        z-index: 1020;
        background-color: white;
    }

    /* Estilos de filtros */
    .card-filtros .card-body {
        padding: 0.75rem 1rem;
    }

    .card-filtros .card-title {
        color: #495057;
        font-size: 1.1rem;
    }

    .card-filtros .form-control,
    .card-filtros .btn {
        font-size: 0.85rem;
    }

    /* Reducir el tamaño de la letra en la tabla */
    .table-sm td,
    .table-sm th {
        font-size: 0.9em;
        text-align: center;
        vertical-align: middle;
    }

    /* Hover effect en las filas */
    .table-hover tbody tr:hover {
        background-color: rgba(0, 123, 255, 0.075);
    }
</style>

<div class="container-custom mt-3">

    <!-- Card de Filtros -->
    <div class="card shadow mb-2 card-filtros">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-clipboard-list me-2"></i>Lista de Salidas
                </h5>
                <div class="d-flex align-items-center gap-3">
                    <div class="input-group" style="width: 300px;">
                        <input type="text" id="searchInput" class="form-control form-control-sm" placeholder="Buscar salidas...">
                        <button type="button" class="btn btn-primary btn-sm" id="buscarBtn">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <a href="/Salida/AltaSalidas" class="btn btn-success btn-sm">
                        <i class="fas fa-plus me-2"></i>Agregar Salida
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Card de Lista de Salidas -->
    <div class="card shadow mb-0">
        <div class="card-header bg-light d-flex align-items-center justify-content-between">
            <strong>Historial de Salidas</strong>
            <div class="d-flex align-items-center gap-3">
                <div id="paginacionSalidas" class="d-flex align-items-center">
                    <nav>
                        <ul class="pagination pagination-sm mb-0">
                            <li class="page-item" id="btnAnteriorSal">
                                <a class="page-link" href="#" onclick="cambiarPaginaSal(-1); return false;">
                                    ← Anterior
                                </a>
                            </li>
                            <li class="page-item">
                                <span class="page-link text-muted" id="infoPaginaSal">Página 1 de 1</span>
                            </li>
                            <li class="page-item" id="btnSiguienteSal">
                                <a class="page-link" href="#" onclick="cambiarPaginaSal(1); return false;">
                                    Siguiente →
                                </a>
                            </li>
                        </ul>
                    </nav>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <select id="tamanoPaginaSal" class="form-select form-select-sm" style="width: auto;">
                        <option value="50">50</option>
                        <option value="100" selected>100</option>
                        <option value="200">200</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive" style="height: 600px; overflow-y: auto;">
                <table id="dataTable" class="table table-striped table-bordered table-hover text-center table-sm mb-0">
                    <thead class="table-header">
                        <tr>
                            <th style="width: 12%;">Código</th>
                            <th style="width: 35%;">Descripción</th>
                            <th style="width: 10%;">Cantidad</th>
                            <th style="width: 25%;">Personal</th>
                            <th style="width: 18%;">Fecha Vale</th>
                        </tr>
                    </thead>
                    <tbody id="salidasBody">
                        <!-- Filas dinámicas -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<style>
    /* Columna Descripción (2da) alineada a la izquierda */
    #dataTable tbody tr td:nth-child(2) {
        text-align: left;
    }
</style>

@section Scripts {
    <script>
        // Función para formatear números (mostrar decimales solo si existen)
        function formatearNumero(num) {
            return num % 1 === 0 ? num.toFixed(0) : num.toFixed(2);
        }

        $(document).ready(function () {
            let paginaActualSal = 1;
            let totalPaginasSal = 1;
            let tamanoPaginaSal = 100;

            function renderSalidas(items) {
                const $tbody = $('#salidasBody');
                $tbody.empty();
                if (!items || items.length === 0) {
                    $tbody.append('<tr><td colspan="5" class="text-center text-muted"><i class="fas fa-info-circle"></i> No se encontraron salidas</td></tr>');
                    return;
                }
                const frag = document.createDocumentFragment();
                items.forEach(x => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${x.itemCodigo || ''}</td>
                        <td>${x.descripcion || ''}</td>
                        <td>${formatearNumero(parseFloat(x.cantidad))}</td>
                        <td>${x.personal || ''}</td>
                        <td>${x.fechaVale || ''}</td>`;
                    frag.appendChild(tr);
                });
                $tbody[0].appendChild(frag);
            }

            function actualizarPaginacion(total) {
                $('#infoPaginaSal').text(`Página ${paginaActualSal} de ${totalPaginasSal} (${total} salidas)`);
                $('#btnAnteriorSal').toggleClass('disabled', paginaActualSal <= 1);
                $('#btnSiguienteSal').toggleClass('disabled', paginaActualSal >= totalPaginasSal);
            }

            function cargarSalidas(pagina = 1) {
                const searchTerm = $('#searchInput').val();
                $.ajax({
                    url: '/Salida/ListJson',
                    type: 'GET',
                    data: { searchTerm: searchTerm, pagina: pagina, tamanoPagina: tamanoPaginaSal },
                    success: function (response) {
                        const items = response?.items || [];
                        paginaActualSal = response?.pagina || 1;
                        tamanoPaginaSal = response?.tamanoPagina || tamanoPaginaSal;
                        const total = (typeof response?.total === 'number') ? response.total : items.length;
                        totalPaginasSal = Math.max(1, Math.ceil(total / tamanoPaginaSal));
                        renderSalidas(items);
                        actualizarPaginacion(total);
                    },
                    error: function (xhr) {
                        console.error('Error al cargar salidas:', xhr.responseText);
                        $('#salidasBody').html('<tr><td colspan="5" class="text-center text-danger">Error al cargar</td></tr>');
                    }
                });
            }

            // Eventos
            $('#searchInput').on('input', function(){
                clearTimeout(window._salDebounce);
                window._salDebounce = setTimeout(() => cargarSalidas(1), 500);
            });
            $('#buscarBtn').on('click', function() {
                cargarSalidas(1);
            });
            window.cambiarPaginaSal = function(delta){ const nueva = paginaActualSal + delta; if(nueva>=1 && nueva<= totalPaginasSal) cargarSalidas(nueva); }
            $('#tamanoPaginaSal').on('change', function(){ tamanoPaginaSal = parseInt($(this).val(),10)||100; cargarSalidas(1); });

            // Inicial
            cargarSalidas(1);
        });
    </script>
}
