@model IEnumerable<dynamic>

@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Lista de Ingresos";
}

<h3>Lista de Ingresos</h3>

<div class="d-flex justify-content-between align-items-center mb-3">
    <a href="/Ingreso/AltaIngresos" class="btn btn-primary">Agregar Ingreso</a>
    <input type="text" id="searchInput" placeholder="Buscar..." class="form-control" style="width: 250px;">
</div>

<div class="table-responsive" style="height: 600px; overflow-y: auto;">
    <table id="dataTable" class="table table-striped table-bordered table-sm">
        <thead class="table-header">
            <tr>
                <th style="width: 10%; text-align: center;">Código del Ítem</th>
                <th style="width: 5%; text-align: center;">Cantidad</th>
                <th style="width: 20%; text-align: center;">Proveedor</th>
                <th style="width: 5%; text-align: center;">Remito</th>
                <th style="width: 10%; text-align: center;">Orden de Compra</th>
                <th style="width: 5%; text-align: center;">N° Pedido</th>
                <th style="width: 5%; text-align: center;">Fecha Remito</th>
            </tr>
        </thead>
        <tbody id="ingresosBody">
            <!-- Filas dinámicas -->
        </tbody>
    </table>
</div>

<!-- Paginación -->
<div id="paginacionIngresos" class="d-flex justify-content-center mt-2">
    <nav>
        <ul class="pagination pagination-sm">
            <li class="page-item" id="btnAnteriorIng">
                <a class="page-link" href="#" onclick="cambiarPaginaIng(-1); return false;">← Anterior</a>
            </li>
            <li class="page-item"><span class="page-link text-muted" id="infoPaginaIng">Página 1 de 1</span></li>
            <li class="page-item" id="btnSiguienteIng">
                <a class="page-link" href="#" onclick="cambiarPaginaIng(1); return false;">Siguiente →</a>
            </li>
        </ul>
    </nav>
    <div class="ms-3">
        <select id="tamanoPaginaIng" class="form-select form-select-sm">
            <option value="50">50</option>
            <option value="100" selected>100</option>
            <option value="200">200</option>
        </select>
    </div>
</div>

<style>
    .table-responsive {
        position: relative;
    }

    .table-header {
        position: sticky;
        top: 0;
        z-index: 1020;
        background-color: white;
        /* Asegúrate de que el fondo sea blanco */
    }
     /* Reducir el tamaño de la letra en la tabla */ 
    .table-sm td, 
    .table-sm th { 
        font-size: 0.9em; 
        text-align: center;
        vertical-align: middle;
    }
</style>

@section Scripts {
    <script>
        $(document).ready(function () {
            let paginaActualIng = 1;
            let totalPaginasIng = 1;
            let tamanoPaginaIng = 100;

            function renderIngresos(items) {
                const $tbody = $('#ingresosBody');
                $tbody.empty();
                if (!items || items.length === 0) {
                    $tbody.append('<tr><td colspan="7" class="text-center text-muted"><i class="fas fa-info-circle"></i> No se encontraron ingresos</td></tr>');
                    return;
                }
                const frag = document.createDocumentFragment();
                items.forEach(x => {
                    const tr = document.createElement('tr');
                    const fecha = x.fechaRemito ? new Date(x.fechaRemito).toLocaleDateString('es-ES') : '';
                    tr.innerHTML = `
                        <td>${x.itemCodigo || ''}</td>
                        <td>${x.cantidadIngreso}</td>
                        <td>${x.proveedor || ''}</td>
                        <td>${x.remito || ''}</td>
                        <td>${x.ordenCompra || ''}</td>
                        <td>${x.numeroPedido || ''}</td>
                        <td>${fecha}</td>`;
                    frag.appendChild(tr);
                });
                $tbody[0].appendChild(frag);
            }

            function actualizarPaginacion(total) {
                $('#infoPaginaIng').text(`Página ${paginaActualIng} de ${totalPaginasIng} (${total} ingresos)`);
                $('#btnAnteriorIng').toggleClass('disabled', paginaActualIng <= 1);
                $('#btnSiguienteIng').toggleClass('disabled', paginaActualIng >= totalPaginasIng);
            }

            function cargarIngresos(pagina = 1) {
                const searchTerm = $('#searchInput').val();
                $.ajax({
                    url: '/Ingreso/ListJson',
                    type: 'GET',
                    data: { searchTerm: searchTerm, pagina: pagina, tamanoPagina: tamanoPaginaIng },
                    success: function (response) {
                        const items = response?.items || [];
                        paginaActualIng = response?.pagina || 1;
                        tamanoPaginaIng = response?.tamanoPagina || tamanoPaginaIng;
                        const total = (typeof response?.total === 'number') ? response.total : items.length;
                        totalPaginasIng = Math.max(1, Math.ceil(total / tamanoPaginaIng));
                        renderIngresos(items);
                        actualizarPaginacion(total);
                    },
                    error: function (xhr) {
                        console.error('Error al cargar ingresos:', xhr.responseText);
                        $('#ingresosBody').html('<tr><td colspan="7" class="text-center text-danger">Error al cargar</td></tr>');
                    }
                });
            }

            // Eventos
            $('#searchInput').on('input', function(){
                clearTimeout(window._ingrDebounce);
                window._ingrDebounce = setTimeout(() => cargarIngresos(1), 500);
            });
            window.cambiarPaginaIng = function(delta){ const nueva = paginaActualIng + delta; if(nueva>=1 && nueva<= totalPaginasIng) cargarIngresos(nueva); }
            $('#tamanoPaginaIng').on('change', function(){ tamanoPaginaIng = parseInt($(this).val(),10)||100; cargarIngresos(1); });

            // Inicial
            cargarIngresos(1);
        });
    </script>
}
