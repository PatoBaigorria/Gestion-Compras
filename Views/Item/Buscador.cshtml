@model Gestion_Compras.ViewModels.FamiliaSubFamiliaViewModel

@{
    Layout = "~/Views/Shared/_LayoutPopup.cshtml";
    ViewData["Title"] = "Buscador de Items";
}

<div class="container-custom mt-3">

    <!-- Filtros de Búsqueda -->
    <div class="row mb-3">
        <div class="col-md-4 col-lg-2">
            <label for="codigoItem" class="form-label">Código</label> 
            <div class="input-group"> 
                <input type="text" id="codigoItem" name="Codigo" class="form-control" maxlength="10"/> 
            </div>
        </div>
        <div class="col-md-4 col-lg-2">
            <label for="familiaSelect" class="form-label">Familia</label>
            <select id="familiaSelect" name="FamiliaId" class="form-select">
                <option value=""</option>
                @foreach (var familia in Model.FamiliaList)
                {
                    <option value="@familia.Id">@familia.Descripcion</option>
                }
            </select>
        </div>
        <div class="col-md-4 col-lg-2">
            <label for="subfamiliaSelect" class="form-label">Subfamilia</label>
            <select id="subfamiliaSelect" name="SubFamiliaId" class="form-select">
                <option value=""</option>
            </select>
        </div>
        <div class="col-md-8 col-lg-4"> 
            <label for="descripcionItem" class="form-label">Descripción Item</label> 
            <div class="input-group"> 
                <input type="text" id="descripcionItem" name="Descripcion" class="form-control"/> 
                <button type="button" class="btn btn-primary" id="buscarItemsBtn"> 
                    <i class="fas fa-search"></i> 
                </button> 
            </div> 
        </div>
        <div class="col-md-4 col-lg-2">
            <label for="filtroComprar" class="form-label">Filtrar</label>
            <div class="form-check mt-2">
                <input class="form-check-input" type="checkbox" id="filtroComprar">
                <label class="form-check-label" for="filtroComprar">
                    <i class="fas fa-shopping-cart text-danger"></i> Solo comprar
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="filtroCritico">
                <label class="form-check-label" for="filtroCritico">
                    <i class="fas fa-exclamation-triangle text-warning"></i> Solo críticos
                </label>
            </div>
        </div>
    </div>

    <!-- Resultados de la Búsqueda -->
    <div class="row"> 
        <div class="col"> 
            <div class="table-responsive" style="height: 600px; overflow-y: auto;">
                <table class="table table-striped table-bordered table-hover text-center table-sm"> 
                    <thead class="table-light"> 
                        <tr> 
                            <th style="width: 80px;">Código</th> 
                            <th style="width: 12%;">Familia</th> 
                            <th style="width: 15%;">Subfamilia</th> 
                            <th style="width: 32%;">Descripción Items</th> 
                            <th style="width: 80px;">Stock</th> 
                            <th style="width: 150px;">Punto de Pedido</th>
                            <th style="width: 80px;">Cant. Pedidos</th>
                            <th style="width: 180px;">Unidad de Medida</th> 
                            <th style="width: 90px;">Precio</th>
                            <th style="width: 70px;">Crítico</th>
                            <th style="width: 100px;">Comprar</th>
                        </tr> 
                    </thead>
                    <tbody id="resultadosBusqueda"> 
                        <!-- Resultados irán aquí --> 
                    </tbody> 
                </table> 
            </div>
        </div> 
    </div>
</div>
<style>
    .container-custom {
        width: 100%;
        padding-right: 15px;
        padding-left: 15px;
        margin-right: auto;
        margin-left: auto;
        max-width: 1400px; /* Un poco más ancho que el container estándar (1200px) */
    }

    .table-responsive {
        position: relative;
    }

    .table-header {
        position: sticky;
        top: 0;
        z-index: 1020;
        background-color: white;
        /* Asegúrate de que el fondo sea blanco */
    }
    /* Reducir el tamaño de la letra en la tabla */ 
    .table-sm td, 
    .table-sm th { 
        font-size: 0.9em; 
    }
</style>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Inicializar Select2 para los elementos de selección
            $('#familiaSelect').select2();
            

            $('#subfamiliaSelect').select2();

            // Cargar subfamilias al seleccionar una familia
            $('#familiaSelect').change(function () {
                const familiaId = $(this).val();
                if (familiaId) {
                    $.ajax({
                        url: '/FamiliaSubFamilia/ObtenerSubfamilias/' + familiaId,
                        type: 'GET',
                        success: function (response) {
                            $('#subfamiliaSelect').empty().append('<option value=""</option>');
                            $.each(response, function (index, subfamilia) {
                                $('#subfamiliaSelect').append(`<option value="${subfamilia.id}">${subfamilia.descripcion}</option>`);
                            });
                            $('#subfamiliaSelect').select2(); // Re-inicializar Select2
                        },
                        error: function (xhr, status, errorThrown) {
                            console.error('Error al obtener subfamilias:', xhr.responseText);
                        }
                    });
                } else {
                    $('#subfamiliaSelect').empty().append('<option value=""</option>').select2(); // Re-inicializar Select2
                }
            });

            // Función para buscar items (reutilizable)
            function buscarItems() {
                const codigo = $('#codigoItem').val() || '';
                const familiaId = $('#familiaSelect').val() || '';
                const subFamiliaId = $('#subfamiliaSelect').val() || '';
                const descripcion = $('#descripcionItem').val() || '';

                $.ajax({
                    url: '/Item/BuscarItems',
                    type: 'GET',
                    data: {
                        codigo: codigo,
                        familiaId: familiaId,
                        subFamiliaId: subFamiliaId,
                        descripcion: descripcion
                    },
                    success: function (response) {
                        const resultados = $('#resultadosBusqueda');
                        resultados.empty();

                        $.each(response, function (index, item) {
                            // Lógica corregida: Stock < PuntoPedido Y (stock + cantidadEnPedidos) < puntoPedido
                            const stockTotal = item.stock + item.cantidadEnPedidos;
                            const necesitaComprar = (item.stock < item.puntoDePedido) && (stockTotal < item.puntoDePedido);
                            const comprarHtml = necesitaComprar ? 
                                '<i class="fas fa-shopping-cart text-danger" title="Necesita comprar"></i>' : 
                                '<span class="text-muted">-</span>';
                            
                            resultados.append(
                                `<tr data-necesita-comprar="${necesitaComprar}" data-critico="${item.critico}">
                                    <td>${item.codigo}</td> 
                                    <td>${item.familiaDescripcion || ''}</td> 
                                    <td>${item.subFamiliaDescripcion || ''}</td> 
                                    <td style="text-align: left">${item.descripcionItem}</td> 
                                    <td>${item.stock !== null ? item.stock : ''}</td> 
                                    <td>${item.puntoDePedido !== null ? item.puntoDePedido : ''}</td>
                                    <td>${item.cantidadEnPedidos !== null ? item.cantidadEnPedidos : '0'}</td>
                                    <td>${item.unidadDeMedidaAbreviatura || ''}</td>
                                    <td>${item.precio !== null ? item.precio : ''}</td>
                                    <td><input type="checkbox" ${item.critico ? 'checked' : ''} disabled></td> 
                                    <td>${comprarHtml}</td>
                                </tr>`
                            );
                        });
                        
                        // Aplicar filtros si están activos
                        aplicarFiltros();
                    },
                    error: function (xhr, status, errorThrown) {
                        console.error('Error al buscar items:', xhr.responseText);
                    }
                });
            }

            // Función para aplicar todos los filtros
            function aplicarFiltros() {
                const filtroComprarActivo = $('#filtroComprar').is(':checked');
                const filtroCriticoActivo = $('#filtroCritico').is(':checked');
                
                $('#resultadosBusqueda tr').each(function() {
                    const necesitaComprar = $(this).data('necesita-comprar');
                    const esCritico = $(this).data('critico');
                    let mostrar = true;
                    
                    // Aplicar filtro de comprar si está activo
                    if (filtroComprarActivo && !necesitaComprar) {
                        mostrar = false;
                    }
                    
                    // Aplicar filtro de crítico si está activo
                    if (filtroCriticoActivo && !esCritico) {
                        mostrar = false;
                    }
                    
                    if (mostrar) {
                        $(this).show();
                    } else {
                        $(this).hide();
                    }
                });
            }

            // Manejar el botón de buscar
            $('#buscarItemsBtn').click(function () {
                buscarItems();
            });

            // Manejar los filtros
            $('#filtroComprar').change(function () {
                aplicarFiltros();
            });

            $('#filtroCritico').change(function () {
                aplicarFiltros();
            });

            // Función para refrescar automáticamente el buscador
            function refrescarBuscador() {
                // Solo refrescar si hay resultados mostrados
                if ($('#resultadosBusqueda tr').length > 0) {
                    buscarItems();
                }
            }

            // Exponer la función globalmente para que otras ventanas puedan llamarla
            window.refrescarBuscador = refrescarBuscador;

            // Verificar si hay cambios en el inventario cada 2 segundos
            setInterval(function() {
                // Verificar si hay cambios en localStorage que indiquen nuevos movimientos
                const ultimoMovimiento = localStorage.getItem('ultimoMovimientoKardex');
                const ultimoCheckBuscador = localStorage.getItem('ultimoCheckBuscador') || '0';
                
                if (ultimoMovimiento && ultimoMovimiento !== ultimoCheckBuscador) {
                    localStorage.setItem('ultimoCheckBuscador', ultimoMovimiento);
                    refrescarBuscador();
                }
            }, 2000);
        });
    </script>
}



